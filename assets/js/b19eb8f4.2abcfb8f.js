"use strict";(self.webpackChunkTHM_Notes=self.webpackChunkTHM_Notes||[]).push([[4674],{6068:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var i=t(4848),r=t(8453);const s={},a="Common Base Potion",c={id:"Events/The Witch's Cauldron",title:"The Witch's Cauldron",description:"The Diffie-Hellman key exchange, named after its inventors Whitfield Diffie and Martin Hellman, is a crucial concept in modern cryptography. It allows two parties to establish a shared secret key over an insecure communication channel without ever exchanging the key itself. This is accomplished by leveraging the properties of modular arithmetic and the computational complexity of discrete logarithm problems.",source:"@site/docs/Events/The Witch's Cauldron.md",sourceDirName:"Events",slug:"/Events/The Witch's Cauldron",permalink:"/docs/Events/The Witch's Cauldron",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"THMSidebar",previous:{title:"Windows Privilege Escalation",permalink:"/docs/Jr Penetration Tester/Privilege Escalation/Windows Privilege Escalation"},next:{title:"Bash Scripting",permalink:"/docs/Others/Bash Scripting"}},o={},l=[];function h(e){const n={code:"code",em:"em",h1:"h1",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"#Events"}),"\n",(0,i.jsx)(n.p,{children:"The Diffie-Hellman key exchange, named after its inventors Whitfield Diffie and Martin Hellman, is a crucial concept in modern cryptography. It allows two parties to establish a shared secret key over an insecure communication channel without ever exchanging the key itself. This is accomplished by leveraging the properties of modular arithmetic and the computational complexity of discrete logarithm problems."}),"\n",(0,i.jsx)(n.h1,{id:"common-base-potion",children:"Common Base Potion"}),"\n",(0,i.jsx)(n.p,{children:"To begin the exchange, Alice and Bob must agree on an arbitrary starting (shared) potion that does not need to be kept secret. They each start by brewing a special base potion in their cauldrons, which are publicly known and form the foundation for their magical key exchange."}),"\n",(0,i.jsxs)(n.p,{children:["The ingredients in this base mixture refer to the selection of the ",(0,i.jsxs)(n.strong,{children:["prime modulus (",(0,i.jsx)(n.em,{children:"p"}),")"]}),", typically a very large prime number, and the ",(0,i.jsxs)(n.strong,{children:["base (",(0,i.jsx)(n.em,{children:"g"}),")"]}),", which are part of the ",(0,i.jsx)(n.strong,{children:"Diffie-Hellman parameters"}),". It's essential that they are known to both parties to generate the foundational criteria of the exchange."]}),"\n",(0,i.jsxs)(n.p,{children:["To generate Diffie-Hellman parameters manually, we can leverage ",(0,i.jsx)(n.strong,{children:"OpenSSL"}),", a software library and command-line toolset commonly used for various cryptographic applications. The following OpenSSL command generates a ",(0,i.jsx)(n.code,{children:"dhparams.pem"})," file that contains the new DH parameters"]}),"\n",(0,i.jsx)(n.p,{children:"Generate DH Parameters"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"user@tryhackme$ openssl dhparam -out dhparams.pem 2048\n"})}),"\n",(0,i.jsx)(n.p,{children:"In this case, we've chosen a key size (prime modulus length) of 2048 bits; a longer key size generally offers greater security but requires more computational resources. This step is typically performed by a certificate authority, but for the sake of this example, let's assume Alice and Bob are generating their parameters. Parameter generation is CPU expensive and is, therefore, generally done in advance."}),"\n",(0,i.jsx)(n.h1,{id:"secret-potions",children:"Secret Potions"}),"\n",(0,i.jsx)(n.p,{children:"In the next step of the exchange, Alice and Bob each create their secret potions using their own secret ingredients. These secret (private) potions are kept confidential and are never exchanged."}),"\n",(0,i.jsxs)(n.p,{children:["The secret potions in this step correspond to the private keys for ",(0,i.jsxs)(n.strong,{children:["Alice (",(0,i.jsx)(n.em,{children:"a"}),")"]})," and ",(0,i.jsxs)(n.strong,{children:["Bob (",(0,i.jsx)(n.em,{children:"b"}),")"]}),". These private keys are made up of large random numbers, which are always kept secret."]}),"\n",(0,i.jsx)(n.p,{children:"Using OpenSSL, Alice and Bob can generate their private keys using the following commands respectively"}),"\n",(0,i.jsx)(n.p,{children:"Generate Alice's Private Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"alice@tryhackme$ openssl genpkey -paramfile dhparams.pem -out alice_private.pem\n"})}),"\n",(0,i.jsx)(n.p,{children:"Generate Bob's Private Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"bob@tryhackme$ openssl genpkey -paramfile dhparams.pem -out bob_private.pem\n"})}),"\n",(0,i.jsxs)(n.p,{children:["These commands generate the ",(0,i.jsx)(n.code,{children:"alice_private.pem"})," and ",(0,i.jsx)(n.code,{children:"bob_private.pem"})," key pairs using the ",(0,i.jsx)(n.code,{children:"dhparams.pem"})," parameters generated previously."]}),"\n",(0,i.jsx)(n.h1,{id:"public-potions",children:"Public Potions"}),"\n",(0,i.jsx)(n.p,{children:"Finally, Alice and Bob combine their secret potion together with the common base potion. This process is like that of a one-way function. Combining two potions to create a mixed brew is trivial. However, given a mixed potion, it is difficult (and very time-consuming) to determine which potions (or ingredients) went into the mixture. As a result, the obtained mixed potions are safe for public exchange and are treated as public keys."}),"\n",(0,i.jsx)(n.p,{children:"In this step, Alice and Bob's public potions are calculated using modular exponentiation."}),"\n",(0,i.jsxs)(n.p,{children:["Alice calculates ",(0,i.jsxs)(n.strong,{children:["Alice's public key (",(0,i.jsx)(n.em,{children:"A"}),")"]})," using the following formula:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"A = (ga) % p"})}),"\n",(0,i.jsxs)(n.p,{children:["Bob calculates ",(0,i.jsxs)(n.strong,{children:["Bob's public key (",(0,i.jsx)(n.em,{children:"B"}),")"]})," using the same formula:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"B = (gb) % p"})}),"\n",(0,i.jsxs)(n.p,{children:["In the above calculations, Alice and Bob take the chosen ",(0,i.jsxs)(n.strong,{children:["base (",(0,i.jsx)(n.em,{children:"g"}),")"]})," and raise it to the power of their private key ",(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.em,{children:"a"})," or ",(0,i.jsx)(n.em,{children:"b"})]}),". Alice and Bob then take the result of that operation and calculate its remainder when divided by the ",(0,i.jsxs)(n.strong,{children:["prime number (",(0,i.jsx)(n.em,{children:"p"}),")"]}),". The modulo operation (",(0,i.jsx)(n.strong,{children:"%"}),") ensures the result is above 0 and below ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"p"})}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Given the nature of modular arithmetic, it is, as a result, very difficult to reverse the calculation and determine what ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"a"})})," or ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"b"})})," are, respectively."]}),"\n",(0,i.jsx)(n.p,{children:"Using the following commands, Alice and Bob can derive their public keys"}),"\n",(0,i.jsx)(n.p,{children:"Generate Alice's Public Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"alice@tryhackme$ openssl pkey -in alice_private.pem -pubout -out alice_public.pem\n"})}),"\n",(0,i.jsx)(n.p,{children:"Generate Bob's Public Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"bob@tryhackme$ openssl pkey -in bob_private.pem -pubout -out bob_public.pem\n"})}),"\n",(0,i.jsx)(n.p,{children:"The above commands take the user's private key and generate the corresponding public key, which can now be exchanged via insecure means (like the Internet) without concern."}),"\n",(0,i.jsx)(n.p,{children:"Next, Alice and Bob will exchange their public keys to complete the final calculation to derive the same shared secret."}),"\n",(0,i.jsx)(n.h1,{id:"shared-secret-potions",children:"Shared Secret Potions"}),"\n",(0,i.jsx)(n.p,{children:"After the exchange, Alice and Bob combine the other person's public potions and their own private potions to compute the shared secret potion. The shared secret potion (key) in this step is calculated using modular exponentiation, deriving the same result for Alice and Bob."}),"\n",(0,i.jsxs)(n.p,{children:["Alice calculates the ",(0,i.jsxs)(n.strong,{children:["shared secret key (",(0,i.jsx)(n.em,{children:"s"}),")"]})," by taking Bob's public key (",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"B"})}),"), raising it to the power of her private key (",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"a"})}),"), and then taking the result modulo ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"p"})}),":"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"s = (Ba) % p"})}),"\n",(0,i.jsxs)(n.p,{children:["Bob calculates the ",(0,i.jsxs)(n.strong,{children:["shared secret key (",(0,i.jsx)(n.em,{children:"s"}),")"]})," by taking Alice's public key (",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"A"})}),"), raising it to the power of his private key (",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"b"})}),"), and then taking the result modulo ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"p"})}),":"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"s = (Ab) % p"})}),"\n",(0,i.jsx)(n.p,{children:"As a result, Alice and Bob have arrived at the same answer despite the fact that neither of them knew each other's private key."}),"\n",(0,i.jsx)(n.p,{children:"Using the following commands, Alice and Bob can calculate the shared secret using OpenSSL"}),"\n",(0,i.jsx)(n.p,{children:"Derive the Shared Secret Key (Alice)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"alice@tryhackme$ openssl pkeyutl -derive -inkey alice_private.pem -peerkey bob_public.pem -out shared_secret.bin\n"})}),"\n",(0,i.jsx)(n.p,{children:"Derive the Shared Secret Key (Bob)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"bob@tryhackme$ openssl pkeyutl -derive -inkey bob_private.pem -peerkey alice_public.pem -out shared_secret.bin\n"})}),"\n",(0,i.jsx)(n.h1,{id:"what-about-eve",children:"What About Eve"}),"\n",(0,i.jsx)(n.p,{children:"Let's discuss Eve, the eavesdropper, and how it would be impossible for her to derive the shared secret key using what she knows."}),"\n",(0,i.jsxs)(n.p,{children:["Eve can see the ",(0,i.jsxs)(n.strong,{children:["prime modulus (",(0,i.jsx)(n.em,{children:"p"}),")"]}),", the ",(0,i.jsxs)(n.strong,{children:["base (",(0,i.jsx)(n.em,{children:"g"}),")"]}),", and even the exchanged ",(0,i.jsxs)(n.strong,{children:["public potions (",(0,i.jsx)(n.em,{children:"A"})," and ",(0,i.jsx)(n.em,{children:"B"}),")"]}),". However, she cannot peek into the cauldrons to know the private potions (Alice's secret and Bob's secret), which are the most critical ingredients for creating the shared secret. Without these private potions, it's impossible for Eve to recreate the shared secret potion."]}),"\n",(0,i.jsxs)(n.p,{children:["Mathematically, this is because calculating the shared secret requires calculating a discrete logarithm problem. Given ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"A"})}),", ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"g"})}),", and ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"p"})}),", it's computationally infeasible to determine ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"a"})})," from the equation ",(0,i.jsx)(n.strong,{children:"A = (ga) % p"}),". The same applies to ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"B"})}),", ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"b"})}),", ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"g"})}),", and ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"p"})}),"."]}),"\n",(0,i.jsx)(n.p,{children:"As a result, even with her observations, Eve cannot recreate the shared secret without access to the private potions (private keys). This ensures the confidentiality and security of the shared secret, allowing Alice and Bob to communicate securely."}),"\n",(0,i.jsx)(n.h1,{id:"encryption-and-decryption-operations",children:"Encryption and Decryption Operations"}),"\n",(0,i.jsx)(n.p,{children:"It is important to note that Diffie-Hellman is simply a key exchange protocol, not an encryption algorithm. On its own, Diffie-Hellman doesn't provide encryption or decryption capabilities, but it is often used in conjunction with other cryptographic algorithms, such as AES (Advanced Encryption Standard), to secure data transmission."}),"\n",(0,i.jsx)(n.p,{children:"Fortunately, OpenSSL not only supports the implementation of Diffie-Hellman key exchange but also offers the ability to encrypt and decrypt data using symmetric keys. Symmetric key encryption, often referred to as shared key encryption, relies on a single key for both encryption and decryption."}),"\n",(0,i.jsx)(n.p,{children:'In The Witch\'s Cauldron, Alice and Bob use their shared secret potion to keep their recipe safe from Eve. First, Bob "encrypts" the recipe by dipping it into the cauldron containing the shared secret mixture. This results in a potion that looks like a jumbled mess, nothing like the original recipe. After which, Bob can safely share this with Alice, even with Eve watching.'}),"\n",(0,i.jsx)(n.p,{children:'Next, Alice, the recipient, can privately "decrypt" and uncover the original recipe since she has the same shared secret potion. By dipping the encrypted recipe into her cauldron, Alice transforms it back into its original, readable form.'}),"\n",(0,i.jsxs)(n.p,{children:["To replicate ",(0,i.jsx)(n.strong,{children:"encryption"})," with OpenSSL, Bob can run the following command"]}),"\n",(0,i.jsx)(n.p,{children:"Encryption Using the Shared Secret Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"bob@tryhackme$ openssl enc -aes-256-cbc -pass file:shared_secret.bin -in recipe.txt -out encrypted_recipe.enc\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To summarize, this command uses the ",(0,i.jsx)(n.strong,{children:"AES-256-CBC"})," encryption algorithm and a shared secret key file (",(0,i.jsx)(n.strong,{children:"shared_secret.bin"}),") to encrypt the contents of ",(0,i.jsx)(n.strong,{children:"recipe.txt"}),". The encrypted result is saved in ",(0,i.jsx)(n.strong,{children:"encrypted_recipe.enc"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["To replicate ",(0,i.jsx)(n.strong,{children:"decryption"})," with OpenSSL, Alice can run the following command"]}),"\n",(0,i.jsx)(n.p,{children:"Decryption Using the Shared Secret Key"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"alice@tryhackme$ openssl aes-256-cbc -d -in encrypted_recipe.enc -pass file:shared_secret.bin -out recipe.txt\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This command uses the same ",(0,i.jsx)(n.strong,{children:"AES-256-CBC"})," encryption algorithm and shared secret key file (",(0,i.jsx)(n.strong,{children:"shared_secret.bin"}),") to decrypt the contents of ",(0,i.jsx)(n.strong,{children:"encrypted_recipe.enc"}),". The result is saved back into ",(0,i.jsx)(n.strong,{children:"recipe.txt"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"And with that, Alice and Bob can communicate securely without exchanging their private keys!"})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var i=t(6540);const r={},s=i.createContext(r);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);